name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: üóÉÔ∏è Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-

      - name: üß™ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            aiogram==3.19.0 \
            aiohappyeyeballs==2.6.1 \
            aiohttp==3.11.16 \
            aiosignal==1.3.2 \
            aiosqlite==0.21.0 \
            alembic==1.14.1 \
            annotated-types==0.7.0 \
            anyio==4.8.0 \
            asgiref==3.8.1 \
            asyncpg==0.30.0 \
            attrs==25.3.0 \
            certifi==2025.1.31 \
            cffi==1.17.1 \
            charset-normalizer==3.4.1 \
            click==8.1.8 \
            colorama==0.4.6 \
            Deprecated==1.2.18 \
            distro==1.9.0 \
            dnspython==2.7.0 \
            email_validator==2.2.0 \
            executing==2.2.0 \
            fastapi==0.115.8 \
            fastapi-cli==0.0.7 \
            filelock==3.18.0 \
            frozenlist==1.5.0 \
            fsspec==2025.3.2 \
            googleapis-common-protos==1.70.0 \
            greenlet==3.1.1 \
            grpcio==1.71.0 \
            h11==0.14.0 \
            h2==4.2.0 \
            hpack==4.1.0 \
            httpcore==1.0.7 \
            httptools==0.6.4 \
            httpx==0.28.1 \
            huggingface-hub==0.30.2 \
            hyperframe==6.1.0 \
            idna==3.10 \
            importlib_metadata==8.6.1 \
            iniconfig==2.1.0 \
            itsdangerous==2.2.0 \
            Jinja2==3.1.5 \
            jiter==0.9.0 \
            joblib==1.4.2 \
            logfire==3.14.0 \
            magic-filter==1.0.12 \
            Mako==1.3.9 \
            markdown-it-py==3.0.0 \
            MarkupSafe==3.0.2 \
            mdurl==0.1.2 \
            mpmath==1.3.0 \
            multidict==6.3.2 \
            networkx==3.4.2 \
            numpy==2.2.5 \
            openai==1.70.0 \
            opentelemetry-api==1.32.1 \
            opentelemetry-exporter-otlp-proto-common==1.32.1 \
            opentelemetry-exporter-otlp-proto-http==1.32.1 \
            opentelemetry-instrumentation==0.53b1 \
            opentelemetry-instrumentation-asgi==0.53b1 \
            opentelemetry-instrumentation-fastapi==0.53b1 \
            opentelemetry-proto==1.32.1 \
            opentelemetry-sdk==1.32.1 \
            opentelemetry-semantic-conventions==0.53b1 \
            opentelemetry-util-http==0.53b1 \
            orjson==3.10.15 \
            packaging==25.0 \
            pillow==11.2.1 \
            pluggy==1.5.0 \
            portalocker==2.10.1 \
            propcache==0.3.1 \
            protobuf==5.29.4 \
            pycparser==2.22 \
            pydantic==2.10.6 \
            pydantic-extra-types==2.10.2 \
            pydantic-settings==2.7.1 \
            pydantic_core==2.27.2 \
            Pygments==2.19.1 \
            PyJWT==2.10.1 \
            pytest==8.3.5 \
            pytest-asyncio==0.26.0 \
            python-dotenv==1.0.1 \
            python-multipart==0.0.20 \
            PyYAML==6.0.2 \
            qdrant-client==1.14.2 \
            regex==2024.11.6 \
            requests==2.32.3 \
            rich==13.9.4 \
            rich-toolkit==0.13.21 \
            safetensors==0.5.3 \
            scikit-learn==1.6.1 \
            scipy==1.15.2 \
            sentence-transformers==4.1.0 \
            setuptools==79.0.1 \
            shellingham==1.5.4 \
            sniffio==1.3.1 \
            sqladmin==0.20.1 \
            SQLAlchemy==2.0.38 \
            starlette==0.45.3 \
            sympy==1.13.3 \
            threadpoolctl==3.6.0 \
            tokenizers==0.21.1 \
            torch==2.7.0 \
            tqdm==4.67.1 \
            transformers==4.51.3 \
            typer==0.15.1 \
            typing_extensions==4.12.2 \
            ujson==5.10.0 \
            urllib3==2.3.0 \
            uvicorn==0.34.0 \
            watchfiles==1.0.4 \
            websockets==15.0 \
            wrapt==1.17.2 \
            WTForms==3.1.2 \
            yarl==1.18.3 \
            zipp==3.21.0

      - name: ‚úÖ Run tests
        run: |
          pytest

      - name: üöÄ Connect and Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          script: |
            cd Archie.AI
            git pull
            docker compose down
            docker compose up -d --build